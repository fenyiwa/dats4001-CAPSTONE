#!/usr/bin/env python3
# summarize_fasta_pure.py — minimal FASTA summarizer using only the standard library.
# Usage:
#   python summarize_fasta_pure.py --fasta data/BCL11A_isoforms.fasta --out outputs/seq_summary.csv --markdown outputs/summary.md

import sys, os, re, csv, hashlib, statistics
from typing import List, Tuple, Dict, Iterable, Optional

PRIME_NORM = str.maketrans({"′": "'", "’": "'"})

def parse_args(argv: List[str]) -> Dict[str, Optional[str]]:
    args = {"--fasta": None, "--out": None, "--markdown": None}
    i = 0
    while i < len(argv):
        if argv[i] in args:
            key = argv[i]
            if i + 1 >= len(argv):
                print(f"[error] Missing value for {key}", file=sys.stderr)
                sys.exit(2)
            args[key] = argv[i+1]
            i += 2
        else:
            i += 1
    if not args["--fasta"] or not args["--out"]:
        print("Usage: python summarize_fasta_pure.py --fasta <path> --out <csv> [--markdown <md>]", file=sys.stderr)
        sys.exit(2)
    return args

def parse_fasta(path: str) -> Iterable[Tuple[str, str]]:
    """Yield (header, sequence) from a FASTA file."""
    if not os.path.exists(path):
        raise FileNotFoundError(f"FASTA not found: {path}")
    with open(path, "r", encoding="utf-8", errors="ignore") as f:
        header = None
        seq_lines = []
        for line in f:
            line = line.strip()
            if not line:
                continue
            if line.startswith(">"):
                if header is not None:
                    yield header, "".join(seq_lines).upper()
                header = line[1:]  # drop '>'
                seq_lines = []
            else:
                seq_lines.append(line)
        if header is not None:
            yield header, "".join(seq_lines).upper()

def gc_percent(seq: str) -> float:
    if not seq:
        return 0.0
    return 100.0 * (seq.count("G") + seq.count("C")) / len(seq)

def isoform_guess(text: str) -> str:
    t = text.translate(PRIME_NORM).upper()
    # Prefer explicit "isoform TAG"
    for tag in ["XL","L'","L","S","XS"]:
        if f"ISOFORM {tag}" in t:
            return tag
    # Generic token match
    for tag in ["XL","L'","L","S","XS"]:
        if re.search(rf'(^|[^A-Z0-9]){re.escape(tag)}([^A-Z0-9]|$)', t):
            return tag
    return ""

def header_fields(h: str):
    """Return (accession, transcript_variant, organism) from a typical NCBI header."""
    h2 = h.translate(PRIME_NORM)
    acc = ""
    var = ""
    org = ""
    m = re.search(r'\b([A-Z]{1,3}_?\d+\.\d+)\b', h2, flags=re.I)
    if m: acc = m.group(1)
    mv = re.search(r'(transcript\s+variant\s+[^,\)\;]+)', h2, flags=re.I)
    if mv: var = mv.group(1)
    mo = re.search(r'\(([^)]+)\)', h2)
    if mo: org = mo.group(1)
    return acc, var, org

def write_csv(rows: List[Dict[str, str]], out_csv: str):
    fieldnames = ["seq_id","accession","transcript_variant","organism","length_nt","gc_percent","n_count","isoform_guess","description","md5"]
    os.makedirs(os.path.dirname(out_csv) or ".", exist_ok=True)
    with open(out_csv, "w", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=fieldnames)
        w.writeheader()
        for r in rows:
            w.writerow(r)

def write_markdown(rows: List[Dict[str, str]], md_path: str):
    os.makedirs(os.path.dirname(md_path) or ".", exist_ok=True)
    with open(md_path, "w", encoding="utf-8") as f:
        f.write("# FASTA Summary (Pure Python)\n\n")
        f.write(f"- **Total sequences:** {len(rows)}\n")
        if rows:
            lengths = [int(r["length_nt"]) for r in rows]
            f.write(f"- **Length (nt):** min={min(lengths)}, median={int(statistics.median(lengths))}, max={max(lengths)}\n")
            # Isoform counts
            iso_counts = {}
            for r in rows:
                tag = r["isoform_guess"] or "unlabeled"
                iso_counts[tag] = iso_counts.get(tag, 0) + 1
            f.write("- **Isoform guesses:** " + ", ".join(f"{k}: {v}" for k, v in sorted(iso_counts.items())) + "\n")
        f.write("\n> Generated by summarize_fasta_pure.py\n")

def main(argv: List[str]):
    args = parse_args(argv)
    fasta = args["--fasta"]
    out_csv = args["--out"]
    md = args["--markdown"]

    rows = []
    for header, seq in parse_fasta(fasta):
        acc, var, org = header_fields(header)
        rows.append({
            "seq_id": header.split()[0],
            "accession": acc,
            "transcript_variant": var,
            "organism": org,
            "length_nt": str(len(seq)),
            "gc_percent": f"{round(gc_percent(seq),3):.3f}",
            "n_count": str(seq.count("N")),
            "isoform_guess": isoform_guess(header),
            "description": header,
            "md5": hashlib.md5(seq.encode('utf-8')).hexdigest()
        })

    write_csv(rows, out_csv)
    if md:
        write_markdown(rows, md)

    print(f"[ok] Wrote {len(rows)} sequences to {out_csv}")
    if md:
        print(f"[ok] Wrote markdown to {md}")

if __name__ == "__main__":
    main(sys.argv[1:])
